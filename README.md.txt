# EV Battery Chemistry Trade Flow Analysis ğŸ”‹

An interactive web application built with Streamlit and Plotly to visualize the global supply chain flows of critical minerals (Lithium, Cobalt, Nickel, and Manganese) from mining to cathode manufacturing.

## âœ¨ Features

- **Interactive Sankey Diagrams**: Visualizes complex trade flows across three main stages: Mining (S1), Refining (S2), and Cathode & Electrolyte Manufacturing (S3-S5).
- **Mass Balance Tracking**: Features an optional "Split Gap" calculation to visually separate domestic production from inventory drawdowns or re-exports.
- **Chemistry Breakdown**: Toggle the final output stage between a country-level breakdown and a battery chemistry-level breakdown (NCA, NCM, LFP).
- **Customizable Layout**: Dynamically reorder nodes based on predefined regional groupings, absolute quantities, or manual drag-and-drop. Move special condition nodes to intermediate columns.
- **Editable Data**: Upload your own `.xlsx` production data directly through the UI or edit quantities inline to simulate different supply chain scenarios.

---

## ğŸ›ï¸ Sidebar Controls

The sidebar provides global configurations for the data pipeline and visual layout.

### 1. General Settings
- **Target Metal**: Choose the critical mineral to analyze (Lithium, Cobalt, Nickel, or Manganese).
- **Target Year**: Select the temporal scope of the analysis (e.g., 2020-2024).
- **Reference Quantity (t)**: A filtering threshold. Trade flows below this tonnage are hidden to reduce visual clutter.
- **Mass Balance Option**: 
  - *No (Default)*: Maps raw export data directly.
  - *Yes (Split Gap)*: If a country exports more raw materials than it mines, the node splits into two. The main node represents actual domestic production, while the darker `(Gap)` node represents the excess (attributed to inventory drawdowns or re-exports), ensuring strict mass balance visual logic.
- **S5 Output Mode**:
  - *By Country*: The final stage (S5) groups production by destination country.
  - *By Chemistry Type*: The final flows are routed into specific battery cathode chemistries (NCA, NCM, LFP), with corresponding chemical branches colored in `#000086`.

### 2. Layout Config (Customize Intermediate Stages)
- Fine-tune the spatial layout of the Sankey diagram by moving "Special Condition Nodes" (e.g., Unaccounted Raw Materials, Unknown Sources) into intermediate columns (S1.5, S2.5, S3.5, S4.5).
- Adjust vertical alignment (Top/Bottom) for these intermediate nodes to prevent line crossing and improve readability.

### 3. Reference & Helpers
- **Search Country**: A quick lookup tool to find the corresponding numerical ID for any country name used in the UN Comtrade dataset.
- **Acronym Legend**: A cheat sheet for all the special nodes generated by the algorithm to account for statistical discrepancies (e.g., `NBCP`, `NTRM`).

---

## ğŸ“ Editor & Sort (Tab 1)

This tab gives you full control over the underlying data and the vertical ordering of the nodes in the diagram.

### âš ï¸ Mandatory Data Upload
**To generate the Sankey diagram, you must upload properly formatted production data files.** Please refer to the empty `.xlsx` template files located in the `data/production/` folder. Fill in your data according to the template formats and upload them via the respective upload buttons in the Editor UI.

### ğŸ“Š Data Editor (S1, S2, S3)
Each major production stage has an interactive data grid:
- **Custom Data Upload**: Next to each stage header (S1, S2, S3), use the upload button to drop your formatted `.xlsx` file. This is required to initialize the data for that session.
- **Inline Editing**: Once the data is loaded, click any cell in the "Quantity" column to manually adjust the production volume for a specific country. The Sankey diagram will dynamically recalculate downstream flows based on your changes.
- **Dynamic Chemistry Split**: If *S5 Output Mode* is set to "By Chemistry Type", the S3 (Manufacturing) table automatically expands to show dedicated input columns for NCM, NCA, and LFP for each country.

### â†•ï¸ Node Ordering
Beneath each data table, you can control how nodes are vertically stacked in the generated diagram:
- **Sort Modes**:
  - *Default*: Prioritizes a predefined regional/strategic ordering for each metal. Special condition nodes are automatically pinned to the top or bottom based on their logical flow (e.g., `NBCP` is always at the top of S5).
  - *Quantity*: Sorts all normal nodes strictly by their total flow volume (largest at the top).
- **Manual Drag-and-Drop**: The multiselect boxes allow you to click the 'x' to remove a node, or click and drag tags to create a 100% custom vertical arrangement.

---

## ğŸ“‚ Project Structure
```text
EV-Battery-Chemistry-Trade-Flow-Analysis/
â”‚
â”œâ”€â”€ app.py                      # Main Streamlit application UI
â”œâ”€â”€ requirements.txt            # Python dependencies
â”œâ”€â”€ README.md                   # Project documentation
â”‚
â”œâ”€â”€ modules/                    # Core logic and configuration
â”‚   â”œâ”€â”€ config.py               # Constants, colors, and default country orders
â”‚   â”œâ”€â”€ data_loader.py          # Data ingestion and processing algorithms
â”‚   â””â”€â”€ sankey_algo.py          # Mass balance routing and spatial layout logic
â”‚
â””â”€â”€ data/                       # Datasets 
    â”œâ”€â”€ reference/              # Country ID mapping files
    â”œâ”€â”€ production/             # Blank templates for S1, S2, S3 data upload
    â””â”€â”€ trade/                  # Processed UN Comtrade data